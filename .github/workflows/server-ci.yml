name: Blooming Server CI with Gradle

on:
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./server/Blooming

    services:
      redis:
        image: redis
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5 # v3.1.0

      - name: Check current directory
        run: ls -al

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Test with Gradle Wrapper
        env:
          CLIENT_ENDPOINT: ${{ secrets.CLIENT_ENDPOINT }}
          CLIENT_HOST: ${{ secrets.CLIENT_HOST }}
          CLIENT_URL: ${{ secrets.CLIENT_URL }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          NAVER_CLIENT_ID:  ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          OPENVIDU_SECRET: ${{ secrets.OPENVIDU_SECRET }}
          OPENVIDU_URL: ${{ secrets.OPENVIDU_URL }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
        run: ./gradlew clean test

      - name: Send Notification to Discord
        uses: sarisia/actions-status-discord@v1.14.0
        if: always()  # 배포 결과 Discord 전송
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
